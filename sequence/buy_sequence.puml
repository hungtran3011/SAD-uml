@startuml Quy trình mua hàng
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam backgroundColor #FFFFFF
skinparam transparentBackground false

actor "User" as User #lightblue
boundary "Shop UI" as UI #palegreen
control "OrderController" as OC #gold
entity "ProductService" as PS #lightsteelblue
entity "OrderService" as OS #pink
control "PaymentGateway" as PG #coral
entity "ShippingService" as SS #wheat
database "DATABASE" as DB #lightgray

' == 1. Khởi tạo quá trình mua hàng ==
' alt Chọn đăng nhập
'     User -> UI : Yêu cầu đăng nhập
'     activate UI
'     UI --> User : Hiển thị trang đăng nhập/đăng ký
'     deactivate UI
'     User -> UI : Đăng nhập vào hệ thống
'     activate UI
'     UI --> User : Xác nhận đăng nhập thành công
'     deactivate UI
' end

' == 2. Tìm kiếm và chọn sản phẩm ==
' User -> UI : Tìm kiếm và xem sản phẩm
' activate UI
' UI -> OC : getProductDetails(productId)
' activate OC
' OC -> PS : findProduct(productId)
' activate PS
' PS -> DB : findOne({_id: productId})
' activate DB
' DB --> PS : productDocument
' deactivate DB
' PS --> OC : productDetails
' deactivate PS
' OC --> UI : productDetails
' deactivate OC
' UI --> User : Hiển thị thông tin sản phẩm
' deactivate UI

' == 3. Thêm vào giỏ hàng ==
' User -> UI : Thêm vào giỏ hàng
' activate UI
' UI -> OC : addToCart(productId, quantity)
' activate OC
' OC -> PS : checkInventory(productId, quantity)
' activate PS
' PS -> DB : findOne({_id: productId})
' activate DB
' DB --> PS : productDocument
' deactivate DB
' PS --> OC : inventoryStatus
' deactivate PS

' alt Hết hàng
'     OC --> UI : <color:red>inventoryError</color>
'     UI --> User : Thông báo sản phẩm hết hàng
' else Còn hàng
'     OC -> OC : updateCart(userId, productId, quantity)
'     OC --> UI : cartUpdated
'     UI --> User : Xác nhận thêm vào giỏ
' end
' deactivate OC
' deactivate UI

== Thanh toán ==
User -> UI : Đi tới giỏ hàng và thanh toán
activate UI
UI -> OC : checkout()
activate OC
OC -> OS : getCartDetails(userId)
activate OS
OS -> DB : findOne({userId: userId})
activate DB
DB --> OS : cartDocument
deactivate DB
OS --> OC : cartDetails
deactivate OS
OC --> UI : orderSummary
UI --> User : Hiển thị thông tin đơn hàng

alt Không đăng nhập (Mua hàng nhanh)
    UI --> User : Yêu cầu nhập thông tin giao hàng và liên hệ
    User -> UI : Nhập thông tin giao hàng (Tên, SĐT, Email, Địa chỉ)
    UI -> OC : validateShippingInfo(shippingInfo)
    OC --> UI : validationResult
    UI --> User : Xác nhận thông tin và hiển thị lựa chọn thanh toán
else Đã đăng nhập
    UI -> OC : getUserShippingInfo(userId)
    OC -> OS : getShippingInfo(userId)
    activate OS
    OS -> DB : findOne({userId: userId})
    activate DB
    DB --> OS : userShippingInfo
    deactivate DB
    OS --> OC : shippingInfo
    deactivate OS
    OC --> UI : shippingInfo
    UI --> User : Hiển thị thông tin giao hàng đã lưu
    User -> UI : Xác nhận hoặc thay đổi thông tin
    UI -> OC : updateShippingInfo(userId, shippingInfo)
    OC --> UI : updateConfirmation
    UI --> User : Hiển thị lựa chọn thanh toán
end

User -> UI : Lựa chọn hình thức thanh toán

alt Thanh toán trực tuyến
    UI -> OC : processOnlinePayment(paymentDetails)
    OC -> PG : processPayment(amount, paymentDetails)
    activate PG
    
    alt Thanh toán thất bại
        PG --> OC : <color:red>paymentError</color>
        OC --> UI : <color:red>paymentError</color>
        UI --> User : Thông báo lỗi và yêu cầu thử lại
    else Thanh toán thành công
        PG --> OC : paymentConfirmed
        OC --> UI : paymentSuccess
        UI --> User : Thông báo thanh toán thành công
    end
    deactivate PG
    
else Thanh toán trực tiếp (COD)
    UI -> OC : processCODPayment()
    OC --> UI : codConfirmed
    UI --> User : Xác nhận chọn COD
end

OC -> OS : createOrder(orderDetails)
activate OS
OS -> DB : insert(orderDocument)
activate DB
DB --> OS : orderCreated
deactivate DB
OS --> OC : orderCreationResult
deactivate OS
OC --> UI : orderDetails
UI --> User : Hiển thị chi tiết đơn hàng
OC -> OC : sendOrderConfirmationEmail(email, orderDetails)
OC --> User : Gửi email xác nhận đơn hàng
deactivate OC

== Quản lý đơn hàng ==
alt Hủy đơn (Trong khoảng thời gian cho phép)
    User -> UI : Yêu cầu hủy đơn hàng
    activate UI
    
    alt Không đăng nhập
        UI --> User : Yêu cầu nhập mã đơn hàng và email xác nhận
        User -> UI : Nhập thông tin xác nhận
        UI -> OC : verifyOrderAccess(orderCode, email)
        activate OC
        OC -> OS : verifyOrderOwnership(orderCode, email)
        activate OS
        OS -> DB : findOne({code: orderCode, email: email})
        activate DB
        DB --> OS : orderDocument
        deactivate DB
        OS --> OC : verificationResult
        deactivate OS
    else Đã đăng nhập
        UI -> OC : verifyOrderAccess(userId, orderId)
        activate OC
        OC -> OS : verifyOrderOwnership(userId, orderId)
        activate OS
        OS -> DB : findOne({_id: orderId, userId: userId})
        activate DB
        DB --> OS : orderDocument
        deactivate DB
        OS --> OC : verificationResult
        deactivate OS
    end
    
    OC --> UI : cancellationForm
    UI --> User : Yêu cầu lý do hủy đơn
    User -> UI : Nhập lý do hủy và xác nhận hủy đơn hàng
    UI -> OC : cancelOrder(orderId, reason)
    OC -> OS : updateOrderStatus(orderId, "cancelled", reason)
    activate OS
    OS -> DB : update({_id: orderId}, {$set: {status: "cancelled", ...}})
    activate DB
    DB --> OS : updateResult
    deactivate DB
    OS --> OC : cancellationResult
    deactivate OS
    
    alt Đã thanh toán online
        OC -> PG : requestRefund(transactionId)
        activate PG
        PG --> OC : refundInitiated
        OC --> UI : refundStatus
        UI --> User : Thông báo trạng thái hoàn tiền
        PG --> User : Hoàn tiền
        deactivate PG
    end
    
    OC -> OC : sendCancellationEmail(email, orderDetails)
    OC --> User : Gửi email xác nhận hủy đơn
    deactivate OC
    deactivate UI
end

== Vận chuyển ==
OC -> SS : createShippingOrder(orderId, shippingDetails)
activate OC
activate SS
SS -> DB : insert(shippingDocument)
activate DB
DB --> SS : shippingCreated
deactivate DB
SS --> OC : shippingDetails
deactivate SS
OC --> UI : trackingInfo
activate UI
UI --> User : Hiển thị chi tiết vận đơn
deactivate UI
deactivate OC

loop Cập nhật trạng thái
    SS -> OC : updateOrderStatus(orderId, status)
    activate SS
    activate OC
    OC -> OS : updateStatus(orderId, status)
    activate OS
    OS -> DB : update({_id: orderId}, {$set: {status: status}})
    activate DB
    DB --> OS : updateResult
    deactivate DB
    OS --> OC : statusUpdated
    deactivate OS
    OC -> OC : notifyUser(userId, statusUpdate)
    OC --> User : Thông báo cập nhật trạng thái
    deactivate OC
    deactivate SS
end

alt COD
    SS -> User : Vận chuyển đơn hàng
    activate SS
    
    alt Giao hàng thành công
        User -> SS : Trả tiền sau khi nhận hàng
        SS -> OC : confirmDelivery(orderId, "paid")
        activate OC
    else Từ chối nhận hàng
        User -> SS : Từ chối nhận hàng
        SS -> OC : reportDeliveryFailure(orderId, reason)
        activate OC
    end
    deactivate SS
    
else Thanh toán trực tuyến
    SS -> User : Vận chuyển đơn hàng (đã thanh toán)
    activate SS
    
    alt Giao hàng thành công
        SS -> OC : confirmDelivery(orderId)
        activate OC
    else Từ chối nhận hàng
        User -> SS : Từ chối nhận hàng
        SS -> OC : reportDeliveryFailure(orderId, reason)
        activate OC
        OC -> PG : processRefund(transactionId)
        activate PG
        deactivate PG
    end
    deactivate SS
end

OC -> OS : finalizeOrder(orderId, status)
activate OS
OS -> DB : update({_id: orderId}, {$set: {status: status, ...}})
activate DB
DB --> OS : updateResult
deactivate DB
OS --> OC : orderFinalized
deactivate OS

alt Giao hàng thành công
    OC --> UI : deliveryConfirmed
    activate UI
    UI --> User : Thông báo giao hàng thành công
    deactivate UI
    OC -> OC : sendDeliveryConfirmationEmail(email, orderDetails)
    OC --> User : Gửi email xác nhận giao hàng
    deactivate OC
    
    alt Đã đăng nhập
        User -> UI : Đánh giá sản phẩm
        activate UI
        UI -> OC : submitReview(productId, rating, comment)
        activate OC
        OC -> PS : saveReview(productId, userId, rating, comment)
        activate PS
        PS -> DB : update({_id: productId}, {$push: {reviews: ...}})
        activate DB
        DB --> PS : reviewSaved
        deactivate DB
        PS --> OC : reviewProcessed
        deactivate PS
        OC --> UI : reviewConfirmation
        deactivate OC
        UI --> User : Xác nhận đánh giá
        deactivate UI
    end
    
    alt Trả/Đổi hàng
        User -> UI : Yêu cầu trả/đổi hàng
        activate UI
        UI -> OC : requestReturn(orderId, reason)
        activate OC
        OC -> OS : createReturnRequest(orderId, reason)
        activate OS
        OS -> DB : insert(returnDocument)
        activate DB
        DB --> OS : returnCreated
        deactivate DB
        OS --> OC : returnInitiated
        deactivate OS
        OC --> UI : returnInstructions
        deactivate OC
        UI --> User : Hướng dẫn quy trình trả/đổi hàng
        deactivate UI
    end
end
@enduml